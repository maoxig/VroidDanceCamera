# VroidDanceCamera

这个dll补丁能够一次性直接解决以往VRoidMod里带运镜的舞蹈的所有问题，包括会在多人下锁定队友镜头、声音忽大忽小、部分舞蹈运镜在部分角色上不生效的问题。

并且使用之后，只要使用的舞蹈带有正确规范的运镜，那么所有的角色模型都会支持运镜。



通过网盘分享的文件：VRoidDanceCamera

链接: https://pan.baidu.com/s/1kovRViCS5-PGEf9zMaWHBQ?pwd=7dfb​ 提取码: 7dfb



对于普通用户

使用方式：

把我写好的编译的dll直接放到VRoidMod文件夹即可：



在游戏内可以按F7关闭UI。



后面的都不用看了，不过如果你在添加这个补丁后遇到问题，或者感兴趣，也可以往后看。



如果你遇到了某个角色、某个舞蹈在引入该补丁后出现了bug，可以阅读下面QA，如果显然是本补丁的bug，请尽量提供详细的信息反馈。在确认无法自行解决问题后提供角色unity3d和舞蹈unity3d，并反馈。



对于感兴趣的用户/角色mod、舞蹈mod开发者，建议阅读以下QA以及原理介绍（也有提供代码）：

Q：会影响原有的转换流程吗？

A：不会，之前怎么转化的现在就怎么搞，我做了许多前向、后向兼容的考虑，因此理论上是都能兼容的。添加了这个dll后，无论角色模型是否内嵌镜头，只要舞蹈unity3d支持运镜，那么就一定会运镜；如果舞蹈unity3d不支持运镜，那么会回退到VRoidMod的镜头逻辑（锁定在人物大概脖子的位置）。因此对于角色模型，不需要再内嵌镜头。对于舞蹈unity3d，可按喜好添加运镜，舞蹈unity3d的制作、运镜的添加、原理我前面的帖子里有详细的图文视频说明：

【七日杀/图文&视频教程】5分钟内教会你在七日杀内跳舞蹈/MMD - 角色模型 - 七日杀中文网



Q：用了xx舞蹈有问题，镜头、表情、动作很怪，是不是这个补丁的问题？

A：显然不是，不过不确定的话可以先移除该补丁然后再对比尝试，如果没法解决可以带着详细的信息反馈。如果是舞蹈本身的问题，请找原作者。



Q：兼容性如何？

A：理论上，这套方案只要七日杀不修改第一人称镜头的相关变量、接口，在未来都是可行且不会报错的，并且理论上兼容以往、未来所有的角色模型和舞蹈动作。



Q：即使修复了多人锁镜头，我也不想有运镜，怎么办？

A：未来可能会在VRoidMod的UI面板上添加一个开关，关闭后使得所有舞蹈即使有镜头也会回退到VRoidMod的默认镜头逻辑，但是也会担心这样会导致兼容性下降。总之看反馈



Q：联机需要每个人都添加这个补丁吗？

A：我没试过，但是最好都添加



Q：原理是什么？是怎么修复多人联机锁镜头的？

首先你要知道原先的运镜方法的原理（见我前面的教程帖子）。但是帖子提到，那种方法会导致多人下队友锁镜头。这是因为激活了不恰当的镜头（Camera_root/Camera_root_1/Camera）导致的冲突。正确的获取和修改镜头位置与旋转的方法是从EntityPlayerLocal.vp_FPCamera.transform（这是一个当前玩家的第一人称镜头，但是因为七日杀还没提供第三人称镜头，因此VRoidMod是把第一人称镜头伪装成第三人称）。



因此我们的目的是使得舞蹈的AnimClip内对Camera_root/Camera_root_1/Camera这三个节点的位移的信息能够合理地传递给外部的EntityPlayerLocal.vp_FPCamera.transform。我设想了许多种方法，最终的方法是在每次EntityPlayerLocal的LateUpdate后面patch一个postfix函数（这个函数在原有的VRoidMod镜头控制逻辑之后执行，因此会覆盖VRoidMod的镜头控制），然后我们检测这三个节点是否在初始位置，如果不在，说明产生了运动，我们就更新EntityPlayerLocal.vp_FPCamera。



此外，为了兼容过去的、未来的所有的情况，我考虑了一下4种（可以合并为2种）情况：

情况 a：人物 Avatar 模型包含 Camera_root/Camera_root_1/Camera 路径层级，舞蹈的动画曲线也包含对该路径的控制。

只需禁用模型中的 Camera 组件，并将 vp_FPCamera 同步到该节点的世界位置和旋转。

情况 b：人物 Avatar 模型不包含上述路径层级，舞蹈的动画曲线也不包含该路径层级。

希望使用 VRoidMod 默认的镜头机制（锁定在人物脖子上），无需额外同步操作。

情况 c：人物 Avatar 模型不包含上述路径层级，但舞蹈的动画曲线包含该路径层级。

动画曲线会尝试控制不存在的路径，可能导致错误。为解决此问题，需要动态创建 Camera_root/Camera_root_1/Camera 层级，并让动画曲线绑定到这些新节点。

情况 d：人物 Avatar 模型包含上述路径层级，但舞蹈的动画曲线不包含该路径层级。

动画曲线不控制镜头，应使用 VRoidMod 默认镜头机制，与情况 b 相同。



因此，在每次开始跳舞前（Prefix），我的补丁会查找 Camera_root/Camera_root_1/Camera 路径，如果不存在，会创建这样的层级（包括镜头），但是会禁用其他所有的镜头（避免镜头竞争）。此外，为了兼容以往的一些错误的模型，我还尝试删除了所有前人多余额外的AudioListener（因为这会导致声音变大变小，并且unity不允许>1的AudioListener），把AudioListener绑定在角色根变换下，这样无论镜头如何移动，舞蹈的声音都会是一样大的。



而在每次EntityPlayerLocal的LateUpdate后面的postfix函数（这个函数会在每一帧周期性执行），我们查找Camera_root/Camera_root_1/Camera 路径，检查每一个节点的变换，只要有一个节点的变换不符合初始位置，这说明舞蹈controller控制了镜头，那么我们判定需要把人称镜头vp_FPCamera的变换、视野与Camera同步。



总之，如果不理解也可以看源代码，如果未来我不维护了，或者因版本更新导致问题，你也可以尝试自行解决


Q: 是怎么修复声音忽大忽小的？

A：这里我也尝试了很多种方案，包括但不限于创建新的AudioListener，使用一二三佬的舞蹈unity修复。但是搞了半天发现很麻烦。后来我发现了最简单最本质的方法：

在开始舞蹈之后，我通过PostFix，把VRoidMod播放音频时的AudioSource设置为 2D 音效（.spatialBlend = 0），这种情况下无论当前玩家镜头在哪音量都是稳定的。而且通过判断是否为本地玩家，可以使得，对自己来说，声音是一致的，而对其他玩家，声音是3D的（会随距离衰减）。总之这套方案应该是很完美的。



Q: 怎么反馈问题？

A：可以先自行解决，如果无法解决可以看看代码理解、问问AI，然后带着详细的信息在评论区反馈



